<!doctype html>
<html>
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Santa Tracker Status</title>
  <style>
    body { font-family: system-ui, sans-serif; margin: 16px; }
    .row { display: flex; gap: 12px; flex-wrap: wrap; }
    .card { border: 1px solid #444; border-radius: 10px; padding: 12px; min-width: 280px; }
    .ok { color: #2ecc71; font-weight: 700; }
    .bad { color: #e74c3c; font-weight: 700; }
    code, pre { background: #111; color: #ddd; padding: 8px; border-radius: 8px; overflow: auto; }
    pre { white-space: pre-wrap; margin: 6px 0 0; }
    .small { opacity: 0.8; font-size: 0.9em; }
    table { width: 100%; border-collapse: collapse; }
    td { border-top: 1px solid #333; padding: 6px; vertical-align: top; }
    button { padding: 6px 10px; border-radius: 8px; border: 1px solid #444; background: #222; color: #ddd; cursor: pointer; }
    button:hover { filter: brightness(1.1); }
    button:disabled { opacity: 0.5; cursor: not-allowed; }
    .btnrow { display:flex; gap:8px; flex-wrap:wrap; margin-top:6px; align-items: center; }
    .result { margin-left: 6px; }
    hr { border:0; border-top:1px solid #333; margin:10px 0; }
  </style>
</head>

<body>
  <h1>Santa Tracker Status</h1>
  <div class="small" id="serverTime">Loading…</div>

  <div class="row">
    <div class="card" style="flex: 1">
      <h2>Services</h2>
      <div class="small" style="margin-bottom:8px;">
        Buttons call <code>/api/service/&lt;unit&gt;/start|stop|restart</code> (POST)
      </div>
      <div id="services">Loading…</div>
    </div>

    <div class="card" style="flex: 1">
      <h2>GPS Fix</h2>
      <div id="gps">Loading…</div>
    </div>
  </div>

  <div class="card" style="margin-top: 12px;">
    <h2>MQTT</h2>
    <div class="small">Subscribed to: <code id="topic"></code></div>
    <h3 style="margin:10px 0 6px 0;">Last 5 messages</h3>
    <div id="mqtt">Loading…</div>
  </div>

<script>
const ADMIN_TOKEN = "oibywgn3pq8nfb3pq9gjfh8no432893ghpfw398q";

async function refresh() {
  try {
    const r = await fetch("/api/status", { cache: "no-store" });
    const d = await r.json();

    // Server time
    const st = document.getElementById("serverTime");
    if (st) st.textContent = "Server time: " + (d.server_time ?? "—");

    // ---- Services (with buttons) ----
    const s = d.services || {};
    const blocks = [];

    for (const key of Object.keys(s)) {
      const svc = s[key] || {};
      const klass = svc.active ? "ok" : "bad";
      const unit = svc.unit || "";
      const rid  = escapeId(unit || key);

      blocks.push(`
        <div style="margin-bottom:14px;">
          <div>
            <b>${escapeHtml(key)}</b>
            (${unit ? `<code>${escapeHtml(unit)}</code>` : `<span class="small">no unit</span>`})
            — <span class="${klass}">${svc.active ? "ACTIVE" : "INACTIVE"}</span>
            <span class="small">(${escapeHtml(svc.state ?? "")})</span>
          </div>

          <div class="btnrow">
            <button onclick="svcAction('${escapeJs(unit)}','start')" ${svc.active ? "disabled" : ""} ${unit ? "" : "disabled"}>Start</button>
            <button onclick="svcAction('${escapeJs(unit)}','stop')" ${svc.active ? "" : "disabled"} ${unit ? "" : "disabled"}>Stop</button>
            <button onclick="svcAction('${escapeJs(unit)}','restart')" ${unit ? "" : "disabled"}>Restart</button>
            <span class="small result" id="result-${rid}"></span>
          </div>

          ${svc.tail ? `<div class="small">${escapeHtml(svc.tail)}</div>` : ``}
        </div>
      `);
    }

    document.getElementById("services").innerHTML = blocks.join("");

    // ---- GPS fix ----
    const fix = d.gps_fix;
    if (!fix) {
      document.getElementById("gps").innerHTML =
        `<span class="bad">No fix data available</span>
         <div class="small">gpsd must be active, and the receiver must have signal.</div>`;
    } else {
      const speedKph = (fix.speed_mps != null) ? (fix.speed_mps * 3.6).toFixed(2) : "—";
      document.getElementById("gps").innerHTML = `
        <table>
          <tr><td>Mode</td><td>${escapeHtml(fix.mode ?? "—")}</td></tr>
          <tr><td>Lat</td><td>${escapeHtml(fix.lat ?? "—")}</td></tr>
          <tr><td>Lon</td><td>${escapeHtml(fix.lon ?? "—")}</td></tr>
          <tr><td>Alt</td><td>${escapeHtml(fix.alt ?? "—")}</td></tr>
          <tr><td>Speed</td><td>${escapeHtml(speedKph)} kph</td></tr>
          <tr><td>Time</td><td>${escapeHtml(fix.time ?? "—")}</td></tr>
        </table>
      `;
    }

    // ---- MQTT last messages ----
    const mqtt = d.mqtt || {};
    document.getElementById("topic").textContent = mqtt.subscribed_topic ?? "—";

    const msgs = mqtt.last_messages || [];
    if (msgs.length === 0) {
      document.getElementById("mqtt").innerHTML = `<span class="small">No messages received yet.</span>`;
    } else {
      document.getElementById("mqtt").innerHTML = `
        <table>
          ${msgs.map(m => `
            <tr>
              <td style="width: 160px">${escapeHtml(m.ts)}</td>
              <td style="width: 260px"><code>${escapeHtml(m.topic)}</code></td>
              <td><pre>${escapeHtml(m.payload)}</pre></td>
            </tr>
          `).join("")}
        </table>
      `;
    }

  } catch (e) {
    console.error("refresh() failed:", e);
    const mqttDiv = document.getElementById("mqtt");
    if (mqttDiv) mqttDiv.innerHTML = `<span class="bad">UI error — check browser console</span>`;
  }
}

async function svcAction(unit, action) {
  if (!unit) return;

  const el = document.getElementById("result-" + escapeId(unit));
  if (el) el.textContent = "Running…";

  try {
    const headers = {};
    if (ADMIN_TOKEN) headers["X-Auth-Token"] = ADMIN_TOKEN;

    const r = await fetch(`/api/service/${encodeURIComponent(unit)}/${encodeURIComponent(action)}`, {
      method: "POST",
      headers
    });

    const j = await r.json().catch(() => ({}));
    if (r.ok && j.ok) {
      if (el) el.textContent = "OK";
    } else {
      const msg = `FAILED (${r.status}) ${j.stderr || j.stdout || ""}`.slice(0, 160);
      if (el) el.textContent = msg;
    }
  } catch (e) {
    if (el) el.textContent = "ERROR " + (e?.message || e);
  }

  setTimeout(refresh, 900);
}

function escapeHtml(str) {
  return (str ?? "")
    .toString()
    .replaceAll("&", "&amp;")
    .replaceAll("<", "&lt;")
    .replaceAll(">", "&gt;");
}

function escapeJs(s) {
  return (s ?? "").toString().replaceAll("\\", "\\\\").replaceAll("'", "\\'");
}

function escapeId(s) {
  return (s ?? "").toString().replaceAll(" ", "_").replaceAll(".", "_").replaceAll("/", "_");
}

refresh();
setInterval(refresh, 2000);
</script>

</body>
</html>
