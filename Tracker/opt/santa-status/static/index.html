<!doctype html>
<html>
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Santa Tracker Status</title>
  <style>
    body { font-family: system-ui, sans-serif; margin: 16px; }

    .row { display: flex; gap: 12px; flex-wrap: wrap; }
    .card { border: 1px solid #444; border-radius: 12px; padding: 14px; min-width: 320px; background: #fff; }
    .card h2 { margin: 0 0 10px 0; }

    .small { opacity: 0.8; font-size: 0.9em; }
    .ok { color: #2ecc71; font-weight: 700; }
    .bad { color: #e74c3c; font-weight: 700; }

    code { background: #111; color: #ddd; padding: 2px 6px; border-radius: 6px; }
    pre {
      background: #111;
      color: #ddd;
      padding: 10px 12px;
      border-radius: 10px;
      overflow: auto;
      white-space: pre-wrap;
      margin: 8px 0 0 0;
      line-height: 1.25;
      font-size: 0.92em;
    }

    table { width: 100%; border-collapse: collapse; }
    td { border-top: 1px solid #333; padding: 6px; vertical-align: top; }

    button {
      padding: 6px 10px;
      border-radius: 8px;
      border: 1px solid #444;
      background: #222;
      color: #ddd;
      cursor: pointer;
    }
    button:hover { filter: brightness(1.1); }
    button:disabled { opacity: 0.5; cursor: not-allowed; }

    hr { border: 0; border-top: 1px solid #333; margin: 12px 0; }

    /* --- Services section (clean layout) --- */
    .services-wrap { display: flex; flex-direction: column; gap: 14px; }

    .svc {
      border-top: 1px solid #333;
      padding-top: 12px;
    }
    .svc:first-child {
      border-top: 0;
      padding-top: 0;
    }

    .svc-head {
      display: flex;
      flex-wrap: wrap;
      align-items: baseline;
      gap: 10px;
    }
    .svc-name {
      font-weight: 800;
      font-size: 1.05em;
    }
    .svc-meta { opacity: 0.8; font-size: 0.92em; }

    .svc-actions {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
      margin-top: 6px;
      align-items: center;
    }
    .svc-result {
      margin-left: 6px;
      opacity: 0.85;
      font-size: 0.92em;
    }
  </style>
</head>

<body>
  <h1>Santa Tracker Status</h1>
  <div class="small" id="serverTime">Loading…</div>

  <div class="row">
    <div class="card" style="flex: 1">
      <h2>Services</h2>
      <div class="small" style="margin-bottom:10px;">
        Buttons call <code>/api/service/&lt;unit&gt;/start|stop|restart</code> (POST)
      </div>

      <div id="services" class="services-wrap">Loading…</div>

      <hr/>

      <h3 style="margin: 0 0 6px 0;">Pi Power</h3>
      <div class="small" style="margin-bottom:8px;">
        These will reboot/power off the Pi running this UI.
      </div>
      <div class="svc-actions">
        <button onclick="powerAction('reboot')">Restart Pi</button>
        <button onclick="powerAction('shutdown')">Shutdown Pi</button>
        <span class="svc-result" id="powerResult"></span>
      </div>
    </div>

    <div class="card" style="flex: 1">
      <h2>Connectivity</h2>
      <div id="internet">Loading…</div>

      <hr/>

      <h2>GPS Fix</h2>
      <div id="gps">Loading…</div>
    </div>
  </div>

  <div class="card" style="margin-top: 12px;">
    <h2>MQTT</h2>
    <div class="small">Subscribed to: <code id="topic"></code></div>
    <h3 style="margin:10px 0 6px 0;">Last 5 messages</h3>
    <div id="mqtt">Loading…</div>
  </div>

<script>
const ADMIN_TOKEN = "oibywgn3pq8nfb3pq9gjfh8no432893ghpfw398q";

async function refresh() {
  try {
    const r = await fetch("/api/status", { cache: "no-store" });
    const d = await r.json();

    // Server time
    const st = document.getElementById("serverTime");
    if (st) st.textContent = "Server time: " + (d.server_time ?? "—");

    // --- Services ---
    const s = d.services || {};
    const blocks = [];

    for (const key of Object.keys(s)) {
      const svc = s[key] || {};
      const klass = svc.active ? "ok" : "bad";
      const unit = svc.unit || "";
      const rid  = escapeId(unit || key);

      // tail can be empty; keep layout consistent
      const tail = (svc.tail || "").trim();

      blocks.push(`
        <div class="svc">
          <div class="svc-head">
            <div class="svc-name">${escapeHtml(unit || key)}</div>
            <div>— <span class="${klass}">${svc.active ? "ACTIVE" : "INACTIVE"}</span>
              <span class="svc-meta">(${escapeHtml(svc.state ?? "")})</span>
            </div>
          </div>

          <div class="svc-actions">
            <button onclick="svcAction('${escapeJs(unit)}','start')" ${(!unit || svc.active) ? "disabled" : ""}>Start</button>
            <button onclick="svcAction('${escapeJs(unit)}','stop')"  ${(!unit || !svc.active) ? "disabled" : ""}>Stop</button>
            <button onclick="svcAction('${escapeJs(unit)}','restart')" ${(!unit) ? "disabled" : ""}>Restart</button>
            <span class="svc-result" id="result-${rid}"></span>
          </div>

          ${tail ? `<pre>${escapeHtml(tail)}</pre>` : ``}
        </div>
      `);
    }

    document.getElementById("services").innerHTML = blocks.join("");

    // --- Internet ---
    const net = d.internet || null;
    const internetDiv = document.getElementById("internet");
    if (!net) {
      internetDiv.innerHTML = `<span class="bad">No internet status available</span>`;
    } else {
      const klass = net.ok ? "ok" : "bad";
      const lat = (net.latency_ms != null) ? `${Number(net.latency_ms).toFixed(1)} ms` : "—";
      internetDiv.innerHTML = `
        <table>
          <tr><td>Status</td><td><span class="${klass}">${net.ok ? "INTERNET UP" : "INTERNET DOWN"}</span></td></tr>
          <tr><td>Target</td><td>${escapeHtml(net.target ?? "—")}</td></tr>
          <tr><td>Latency</td><td>${escapeHtml(lat)}</td></tr>
          <tr><td>Detail</td><td class="small">${escapeHtml(net.detail ?? "")}</td></tr>
        </table>
      `;
    }

    // --- GPS fix ---
    const fix = d.gps_fix;
    if (!fix) {
      document.getElementById("gps").innerHTML =
        `<span class="bad">No fix data available</span>
         <div class="small">gpsd must be active, and the receiver must have signal.</div>`;
    } else {
      const speedKph = (fix.speed_mps != null) ? (fix.speed_mps * 3.6).toFixed(2) : "—";
      document.getElementById("gps").innerHTML = `
        <table>
          <tr><td>Mode</td><td>${escapeHtml(fix.mode ?? "—")}</td></tr>
          <tr><td>Lat</td><td>${escapeHtml(fix.lat ?? "—")}</td></tr>
          <tr><td>Lon</td><td>${escapeHtml(fix.lon ?? "—")}</td></tr>
          <tr><td>Alt</td><td>${escapeHtml(fix.alt ?? "—")}</td></tr>
          <tr><td>Speed</td><td>${escapeHtml(speedKph)} kph</td></tr>
          <tr><td>Time</td><td>${escapeHtml(fix.time ?? "—")}</td></tr>
        </table>
      `;
    }

    // --- MQTT ---
    const mqtt = d.mqtt || {};
    document.getElementById("topic").textContent = mqtt.subscribed_topic ?? "—";

    const msgs = mqtt.last_messages || [];
    if (msgs.length === 0) {
      document.getElementById("mqtt").innerHTML = `<span class="small">No messages received yet.</span>`;
    } else {
      document.getElementById("mqtt").innerHTML = `
        <table>
          ${msgs.map(m => `
            <tr>
              <td style="width: 160px">${escapeHtml(m.ts)}</td>
              <td style="width: 260px"><code>${escapeHtml(m.topic)}</code></td>
              <td><pre>${escapeHtml(m.payload)}</pre></td>
            </tr>
          `).join("")}
        </table>
      `;
    }

  } catch (e) {
    console.error("refresh() failed:", e);
    const mqttDiv = document.getElementById("mqtt");
    if (mqttDiv) mqttDiv.innerHTML = `<span class="bad">UI error — check browser console</span>`;
  }
}

async function svcAction(unit, action) {
  if (!unit) return;

  const el = document.getElementById("result-" + escapeId(unit));
  if (el) el.textContent = "Running…";

  try {
    const headers = {};
    if (ADMIN_TOKEN) headers["X-Auth-Token"] = ADMIN_TOKEN;

    const r = await fetch(`/api/service/${encodeURIComponent(unit)}/${encodeURIComponent(action)}`, {
      method: "POST",
      headers
    });

    const j = await r.json().catch(() => ({}));
    if (r.ok && j.ok) {
      if (el) el.textContent = "OK";
    } else {
      const msg = `FAILED (${r.status}) ${j.stderr || j.stdout || ""}`.slice(0, 160);
      if (el) el.textContent = msg;
    }
  } catch (e) {
    if (el) el.textContent = "ERROR " + (e?.message || e);
  }

  setTimeout(refresh, 900);
}

async function powerAction(action) {
  const msg = (action === "reboot")
    ? "Restart the Pi now?"
    : "Shutdown the Pi now? (You will need to power-cycle to bring it back.)";

  if (!confirm(msg)) return;

  const el = document.getElementById("powerResult");
  if (el) el.textContent = "Running…";

  try {
    const headers = {};
    if (ADMIN_TOKEN) headers["X-Auth-Token"] = ADMIN_TOKEN;

    const r = await fetch(`/api/power/${encodeURIComponent(action)}`, {
      method: "POST",
      headers
    });

    const j = await r.json().catch(() => ({}));
    if (r.ok && j.ok) {
      if (el) el.textContent = "OK";
    } else {
      const msg2 = `FAILED (${r.status}) ${j.stderr || j.stdout || ""}`.slice(0, 160);
      if (el) el.textContent = msg2;
    }
  } catch (e) {
    if (el) el.textContent = "ERROR " + (e?.message || e);
  }
}

function escapeHtml(str) {
  return (str ?? "")
    .toString()
    .replaceAll("&", "&amp;")
    .replaceAll("<", "&lt;")
    .replaceAll(">", "&gt;");
}
function escapeJs(s) {
  return (s ?? "").toString().replaceAll("\\", "\\\\").replaceAll("'", "\\'");
}
function escapeId(s) {
  return (s ?? "").toString().replaceAll(" ", "_").replaceAll(".", "_").replaceAll("/", "_");
}

refresh();
setInterval(refresh, 2000);
</script>

</body>
</html>
